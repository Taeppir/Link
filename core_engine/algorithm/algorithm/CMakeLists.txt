cmake_minimum_required(VERSION 3.15)

# ============================================
# CRITICAL: í˜„ì¬ í™œì„±í™”ëœ Python ìë™ ê°ì§€
# ============================================
# vcpkgì˜ Pythonì„ ì°¾ì§€ ì•Šë„ë¡ ì„¤ì •
set(Python_FIND_REGISTRY NEVER)
set(Python_FIND_VIRTUALENV FIRST)  # ê°€ìƒí™˜ê²½ ìš°ì„ 
set(CMAKE_FIND_USE_PACKAGE_REGISTRY FALSE)

# PATHì—ì„œ python.exe ì°¾ê¸° (conda í™˜ê²½ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¾ìŒ)
find_program(ACTIVE_PYTHON_EXECUTABLE 
    NAMES python python.exe
    PATHS ENV PATH
    NO_DEFAULT_PATH
    NO_CMAKE_FIND_ROOT_PATH
)

if(ACTIVE_PYTHON_EXECUTABLE)
    message(STATUS "ğŸ” ë°œê²¬ëœ Python: ${ACTIVE_PYTHON_EXECUTABLE}")
    
    # Python ë²„ì „ í™•ì¸
    execute_process(
        COMMAND "${ACTIVE_PYTHON_EXECUTABLE}" --version
        OUTPUT_VARIABLE PYTHON_VERSION_STRING
        ERROR_VARIABLE PYTHON_VERSION_STRING
        OUTPUT_STRIP_TRAILING_WHITESPACE
        ERROR_STRIP_TRAILING_WHITESPACE
    )
    message(STATUS "ğŸ“Œ Python ë²„ì „: ${PYTHON_VERSION_STRING}")
    
    # Python 3.9ê°€ ì•„ë‹ˆë©´ ê²½ê³ 
    if(NOT PYTHON_VERSION_STRING MATCHES "3\\.9")
        message(WARNING "âš ï¸  Python 3.9ê°€ ì•„ë‹™ë‹ˆë‹¤: ${PYTHON_VERSION_STRING}")
        message(WARNING "âš ï¸  'conda activate ship_env' ë¥¼ ì‹¤í–‰í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!")
    endif()
    
    # Python ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ì¶”ì¶œ (python.exeì˜ ìƒìœ„ ë””ë ‰í† ë¦¬)
    get_filename_component(PYTHON_ROOT_DIR "${ACTIVE_PYTHON_EXECUTABLE}" DIRECTORY)
    set(PYTHON_ROOT_DIR "${PYTHON_ROOT_DIR}" CACHE PATH "Python root directory" FORCE)
    message(STATUS "ğŸ” Python ë£¨íŠ¸: ${PYTHON_ROOT_DIR}")
    
    # Python ê²½ë¡œ ê°•ì œ ì„¤ì •
    set(Python_ROOT_DIR "${PYTHON_ROOT_DIR}" CACHE PATH "Python root directory" FORCE)
    set(Python_EXECUTABLE "${ACTIVE_PYTHON_EXECUTABLE}" CACHE FILEPATH "Python executable" FORCE)
    set(Python3_EXECUTABLE "${ACTIVE_PYTHON_EXECUTABLE}" CACHE FILEPATH "Python3 executable" FORCE)
    
    # Python Development ê²½ë¡œ ëª…ì‹œ
    set(Python_INCLUDE_DIR "${PYTHON_ROOT_DIR}/include" CACHE PATH "Python include directory" FORCE)
    set(Python_LIBRARY "${PYTHON_ROOT_DIR}/libs/python39.lib" CACHE FILEPATH "Python library" FORCE)
    set(Python_INCLUDE_DIRS "${PYTHON_ROOT_DIR}/include" CACHE PATH "Python include directories" FORCE)
    set(Python_LIBRARIES "${PYTHON_ROOT_DIR}/libs/python39.lib" CACHE FILEPATH "Python libraries" FORCE)
    
    message(STATUS "ğŸ“‚ Python Include: ${Python_INCLUDE_DIR}")
    message(STATUS "ğŸ“‚ Python Library: ${Python_LIBRARY}")
else()
    message(FATAL_ERROR "âŒ Pythonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! 'conda activate ship_env' ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
endif()

# vcpkg toolchain ì„¤ì • (Python ì„¤ì • í›„ì—!)
if(NOT DEFINED CMAKE_TOOLCHAIN_FILE)
    set(CMAKE_TOOLCHAIN_FILE "C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
        CACHE STRING "Vcpkg toolchain file")
endif()

project(ShipRouting VERSION 1.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# UTF-8 ì¸ì½”ë”© ì„¤ì • (ì¸ì½”ë”© ê²½ê³  ì œê±°)
if(MSVC)
    add_compile_options(/utf-8)
endif()

# ============================================
# Python ê²€ì¦ ë° í™•ì¸
# ============================================
find_package(Python 3.9 EXACT REQUIRED COMPONENTS Interpreter)
find_package(Python 3.9 EXACT COMPONENTS Development)

message(STATUS "================================")
message(STATUS "Python Configuration:")
message(STATUS "  âœ… Python Version: ${Python_VERSION}")
message(STATUS "  âœ… Python Executable: ${Python_EXECUTABLE}")
if(Python_INCLUDE_DIRS)
    message(STATUS "  âœ… Python Include: ${Python_INCLUDE_DIRS}")
endif()
if(Python_LIBRARIES)
    message(STATUS "  âœ… Python Libraries: ${Python_LIBRARIES}")
endif()
message(STATUS "================================")

# pybind11ì´ í•„ìš”ë¡œ í•˜ëŠ” ë³€ìˆ˜ë“¤ ì„¤ì •
if(NOT Python_INCLUDE_DIRS)
    set(Python_INCLUDE_DIRS "${PYTHON_ROOT_DIR}/include" CACHE PATH "Python include dirs" FORCE)
endif()
if(NOT Python_LIBRARIES)
    set(Python_LIBRARIES "${PYTHON_ROOT_DIR}/libs/python39.lib" CACHE FILEPATH "Python libs" FORCE)
endif()

set(PYBIND11_FINDPYTHON ON)
set(PYBIND11_PYTHON_VERSION "3.9")

# ============================================
# Pybind11 ì„¤ì •
# ============================================
set(pybind11_DIR "C:/vcpkg/installed/x64-windows/share/pybind11")

find_package(pybind11 CONFIG REQUIRED)
message(STATUS "Pybind11 Found: ${pybind11_FOUND}")
message(STATUS "Pybind11 DIR: ${pybind11_DIR}")

# ============================================
# GDAL ì„¤ì •
# ============================================
set(GDAL_INCLUDE_DIR "C:/vcpkg/installed/x64-windows/include")
set(GDAL_LIBRARY "C:/vcpkg/installed/x64-windows/lib/gdal.lib")
find_package(GDAL QUIET)

message(STATUS "GDAL Include: ${GDAL_INCLUDE_DIR}")
message(STATUS "GDAL Library: ${GDAL_LIBRARY}")

# ============================================
# DLL ìë™ ë³µì‚¬ í•¨ìˆ˜
# ============================================
function(copy_dll_to_target target_name)
    # í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ data/dll/ShipDynamics.dll
    set(DLL_SOURCE "${CMAKE_SOURCE_DIR}/../../../data/dll/ShipDynamics.dll")
    
    if(EXISTS "${DLL_SOURCE}")
        # ë¹Œë“œ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
        add_custom_command(TARGET ${target_name} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${DLL_SOURCE}"
                "$<TARGET_FILE_DIR:${target_name}>/ShipDynamics.dll"
            COMMENT "Copying ShipDynamics.dll to ${target_name} output directory"
        )
        message(STATUS "  [DLL] Will copy ShipDynamics.dll for ${target_name}")
    else()
        message(WARNING "  [DLL] ShipDynamics.dll not found at: ${DLL_SOURCE}")
        message(WARNING "  [DLL] Please place ShipDynamics.dll in: LINK/data/dll/")
    endif()
endfunction()

# ============================================
# 1. types ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================
add_library(types STATIC
    types/grid_types.cpp
    types/geo_types.cpp
)
target_include_directories(types PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

# ============================================
# 2. utils ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================
add_library(utils STATIC
    utils/dll_loader.cpp
    utils/fuel_calculator.cpp
    utils/geo_calculations.cpp
    utils/weather_interpolation.cpp
)
target_include_directories(utils PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(utils PUBLIC types)

# ============================================
# 3. data_loading ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================
add_library(data_loading STATIC
    data_loading/gebco_loader.cpp
    data_loading/gshhs_loader.cpp
    data_loading/grid_builder.cpp
    data_loading/weather_loader.cpp
)
target_include_directories(data_loading PUBLIC 
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${GDAL_INCLUDE_DIR}
)
target_link_libraries(data_loading PUBLIC 
    types 
    ${GDAL_LIBRARY}
)

# ============================================
# 4. route_analysis ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================
add_library(route_analysis STATIC
    route_analysis/waypoint_snapper.cpp
)
target_include_directories(route_analysis PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(route_analysis PUBLIC 
    types
    utils
)

# ============================================
# 5. pathfinding ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================
add_library(pathfinding STATIC
    pathfinding/path_utils.cpp
    pathfinding/a_star_engine.cpp
    pathfinding/shortest_planner.cpp
    pathfinding/optimized_planner.cpp
)
target_include_directories(pathfinding PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(pathfinding PUBLIC 
    types
    utils
)

# ============================================
# 6. api ë¼ì´ë¸ŒëŸ¬ë¦¬ (ShipRouter)
# ============================================
add_library(ship_routing_api STATIC
    api/ship_router.cpp
)
target_include_directories(ship_routing_api PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
target_link_libraries(ship_routing_api PUBLIC 
    types
    utils
    data_loading
    route_analysis
    pathfinding
)

# ============================================
# 7. Python Binding Module (algorithm_module)
# ============================================
pybind11_add_module(algorithm_module bindings.cpp)

target_link_libraries(algorithm_module PRIVATE
    ship_routing_api
    pathfinding
    route_analysis
    data_loading
    utils
    types
)

# .pyd íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¡œ ìë™ ë³µì‚¬
add_custom_command(TARGET algorithm_module POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "$<TARGET_FILE:algorithm_module>"
        "${CMAKE_SOURCE_DIR}/../../../$<TARGET_FILE_NAME:algorithm_module>"
    COMMENT "Copying .pyd to project root: ${CMAKE_SOURCE_DIR}/../../../"
)

# Python ëª¨ë“ˆì—ë„ DLL ë³µì‚¬ (ë¹Œë“œ ë””ë ‰í† ë¦¬ìš©)
copy_dll_to_target(algorithm_module)

# ============================================
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ (ì„ íƒì‚¬í•­)
# ============================================

# Test 2: ShipRouter ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸
add_executable(test_ship_router
    test/test_ship_router.cpp
)
target_link_libraries(test_ship_router PRIVATE
    ship_routing_api
    pathfinding
    data_loading
    route_analysis
    types
    utils
)
copy_dll_to_target(test_ship_router)

# Visual Studioì—ì„œ ì‹¤í–‰ ì‹œ ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ LINK í´ë”ë¡œ ì„¤ì •
set_target_properties(test_ship_router PROPERTIES
    VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_SOURCE_DIR}/../../.."
)

# ============================================
# ë¹Œë“œ ì •ë³´ ì¶œë ¥
# ============================================
message(STATUS "================================")
message(STATUS "Build Configuration:")
message(STATUS "  types: 2 files")
message(STATUS "  utils: 4 files")
message(STATUS "  data_loading: 4 files")
message(STATUS "  route_analysis: 1 file")
message(STATUS "  pathfinding: 4 files")
message(STATUS "  api: 1 file (ship_router)")
message(STATUS "  [PYTHON] algorithm_module: bindings.cpp") 
message(STATUS "")
message(STATUS "Targets:")
message(STATUS "  algorithm_module      - Python binding (.pyd)")
message(STATUS "  test_grid_snapper     - Grid & Snapping test (optional)")
message(STATUS "  test_ship_router      - Full integration test (optional)")
message(STATUS "")
message(STATUS "Auto-copy on build:")
message(STATUS "  - algorithm_module.pyd -> LINK/")
message(STATUS "  - ShipDynamics.dll -> LINK/")
message(STATUS "")
message(STATUS "Data files required in LINK/data/:")
message(STATUS "  - gebco/GEBCO_2024_sub_ice_topo.nc")
message(STATUS "  - gshhs/GSHHS_i_L1.shp")
message(STATUS "  - weather/*.bin (optional)")
message(STATUS "  - dll/ShipDynamics.dll")
message(STATUS "================================")